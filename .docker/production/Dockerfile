# Base image with Node.js 20
FROM node:20 AS build

# Set environment variables
ARG REACT_APP_API_URL
ARG REACT_APP_GA_TRACKING_ID
ARG REACT_APP_OAUTH_FACEBOOK_URL
ARG REACT_APP_OAUTH_GOOGLE_URL
ARG REACT_APP_OAUTH_MICROSOFT_TEAMS_URL
ARG REACT_APP_OAUTH_MICROSOFT_URL
ARG REACT_APP_OAUTH_STRIPE_URL
ARG REACT_APP_OAUTH_TWITCH_URL
ARG REACT_APP_OAUTH_TIKTOK_URL
ARG REACT_APP_OAUTH_URL
ARG REACT_APP_OAUTH_YOUTUBE_URL
ARG REACT_APP_SITE_DOMAIN
ARG REACT_APP_SITE_TAG_DESCRIPTION
ARG REACT_APP_TEMPLATE_DIRECTORY
ARG REACT_APP_SITE_TITLE
ARG REACT_APP_SITE_TAG_LINE
ARG REACT_APP_COPYRIGHT
ARG REACT_APP_STRIPE_PUBLIC_KEY
ARG REACT_APP_STRIPE_SUBSCRIPTION_INFLUENCER_FLAT
ARG REACT_APP_STRIPE_SUBSCRIPTION_INFLUENCER_PLAN1
ARG REACT_APP_STRIPE_SUBSCRIPTION_INFLUENCER_PLAN2
ARG REACT_APP_STRIPE_SUBSCRIPTION_INFLUENCER_PLAN3

# Set the working directory
WORKDIR /app

# Copy the source code
COPY . ./

# Install dependencies
RUN npm install

# Build the React application
RUN npm run build

# Stage 2: Set up Nginx
FROM fholzer/nginx-brotli:v1.23.4

WORKDIR /etc/nginx
# Copy the Nginx configuration file
COPY ./.docker/production/nginx.conf /etc/nginx/nginx.conf

# Copy the build output from the previous stage
COPY --from=build /app/build /usr/share/nginx/html

# Expose port 80
EXPOSE 80 8080

# Start Nginx when the container starts
CMD ["nginx", "-g", "daemon off;"]
